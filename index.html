<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    let map;
    let driverMarkers = [];
    let driverRoutes = [];
    const DRIVERS_COUNT = 20;
    const UPDATE_INTERVAL = 3000;
    const VEHICLE_IMAGES = [
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__5_-removebg-preview.png",
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__6_-removebg-preview.png",
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__7_-removebg-preview.png",
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/driver.png"
    ];

    function initMap() {
      const params = new URLSearchParams(window.location.search);
      const userLat = parseFloat(params.get("userLat")) || 41.1533;
      const userLng = parseFloat(params.get("userLng")) || 20.1683;

      map = L.map("map").setView([userLat, userLng], 10);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
      }).addTo(map);

      L.marker([userLat, userLng], {
        icon: L.icon({
          iconUrl: "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/Your_paragraph_text__4_-removebg-preview.png",
          iconSize: [50, 50]
        })
      }).addTo(map);

      for (let i = 0; i < DRIVERS_COUNT; i++) {
        const start = randomPoint(userLat, userLng, 0.05);
        const end = randomPoint(userLat, userLng, 0.05);
        createDriver(start, end, i % VEHICLE_IMAGES.length);
      }

      setInterval(updateDriverPositions, UPDATE_INTERVAL);
    }

    function randomPoint(lat, lng, range) {
      return [
        lat + (Math.random() * 2 - 1) * range,
        lng + (Math.random() * 2 - 1) * range
      ];
    }

    function createDriver(start, end, vehicleImageIndex) {
      const marker = L.marker(start, {
        icon: L.icon({
          iconUrl: VEHICLE_IMAGES[vehicleImageIndex],
          iconSize: [50, 50]
        })
      }).addTo(map);

      driverMarkers.push({ marker, routeIndex: 0 });

      fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`)
        .then(response => response.json())
        .then(data => {
          if (data.routes.length > 0) {
            const route = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
            driverRoutes.push({ marker, route, routeIndex: 0 });

            L.polyline(route, { color: "blue", weight: 3 }).addTo(map);
          }
        });
    }

    function updateDriverPositions() {
      driverRoutes.forEach(driver => {
        if (driver.route && driver.route.length > 1) {
          const nextIndex = (driver.routeIndex + 1) % driver.route.length;
          driver.marker.setLatLng(driver.route[nextIndex]);
          driver.routeIndex = nextIndex;
        }
      });
    }

    initMap();
  </script>
</body>
</html>
