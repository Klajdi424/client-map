<!DOCTYPE html>
<html>
<head>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDESOPDnAmfX5e5qqWc0Smy6kpj3kfN_J0" async defer></script>
  <script>
    let map, userMarker, driverMarkers = [], driverPositions = [];
    
    const SPEED_KMH = 15; 
    const MS_PER_HOUR = 3600000; 
    const LAT_LNG_TO_KM = 111; 
    
    function initMap() {
      const params = new URLSearchParams(window.location.search);
      const userLoc = {
        lat: parseFloat(params.get("userLat")) || 51.5074, 
        lng: parseFloat(params.get("userLng")) || -0.1278
      };

      map = new google.maps.Map(document.getElementById("map"), {
        center: userLoc,
        zoom: 13,
        disableDefaultUI: true
      });

      userMarker = new google.maps.Marker({
        position: userLoc,
        map: map,
        icon: {
          url: "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/images%20(9).jpg",
          scaledSize: new google.maps.Size(50, 50) 
        }
      });

      addDrivers(userLoc);

      const bounds = new google.maps.LatLngBounds();
      bounds.extend(userLoc);
      driverMarkers.forEach(marker => bounds.extend(marker.getPosition()));
      map.fitBounds(bounds);

      setInterval(updateDriverPositions, 2000);
    }

    function addDrivers(userLoc) {
      const categories = [
        { icon: "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__5_-removebg-preview.png", count: 5 }, 
        { icon: "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__6_-removebg-preview.png", count: 5 }, 
        { icon: "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__7_-removebg-preview.png", count: 5 }, 
        { icon: "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/driver.png", count: 5 }  
      ];

      categories.forEach(cat => {
        for (let i = 0; i < cat.count; i++) {
          const offsetLat = (Math.random() - 0.5) * 0.02;
          const offsetLng = (Math.random() - 0.5) * 0.02;
          const driverLoc = { lat: userLoc.lat + offsetLat, lng: userLoc.lng + offsetLng };
          const marker = new google.maps.Marker({
            position: driverLoc,
            map: map,
            icon: { url: cat.icon, scaledSize: new google.maps.Size(50, 50) }
          });

          driverMarkers.push(marker);
          driverPositions.push(driverLoc); 
        }
      });
    }

    function updateDriverPositions() {
      driverMarkers.forEach((marker, index) => {
        const oldPosition = driverPositions[index];
        const newPosition = getRandomLocation(oldPosition);

        smoothMoveMarker(marker, oldPosition, newPosition);

        driverPositions[index] = newPosition;
      });
    }

    function getRandomLocation(oldPosition) {
      const offsetLat = (Math.random() - 0.5) * 0.01;
      const offsetLng = (Math.random() - 0.5) * 0.01;
      return { lat: oldPosition.lat + offsetLat, lng: oldPosition.lng + offsetLng };
    }

    function smoothMoveMarker(marker, oldPosition, newPosition) {
      const frames = 100; 
      const deltaLat = (newPosition.lat - oldPosition.lat) / frames;
      const deltaLng = (newPosition.lng - oldPosition.lng) / frames;

      const distance = calculateDistance(oldPosition, newPosition); 
      const timeToMove = (distance / SPEED_KMH) * MS_PER_HOUR; 
      const intervalTime = timeToMove / frames;

      let count = 0;
      const interval = setInterval(() => {
        count++;
        const nextLat = oldPosition.lat + deltaLat * count;
        const nextLng = oldPosition.lng + deltaLng * count;

        marker.setPosition(new google.maps.LatLng(nextLat, nextLng));

        if (count >= frames) {
          clearInterval(interval);
        }
      }, intervalTime);
    }

    function calculateDistance(pos1, pos2) {
      const lat1 = pos1.lat;
      const lon1 = pos1.lng;
      const lat2 = pos2.lat;
      const lon2 = pos2.lng;

      const radlat1 = Math.PI * lat1 / 180;
      const radlat2 = Math.PI * lat2 / 180;
      const theta = lon1 - lon2;
      const radtheta = Math.PI * theta / 180;
      let dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
      dist = Math.acos(dist);
      dist = dist * 180 / Math.PI;
      dist = dist * 60 * 1.1515; 
      dist = dist * 1.609344; 

      return dist;
    }
  </script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body onload="initMap()">
  <div id="map"></div>
</body>
</html>
