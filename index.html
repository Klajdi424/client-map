<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script>
    let map;
    const driverMarkers = [];
    const driverRoutes = [];
    const DRIVERS_COUNT = 10;
    const UPDATE_INTERVAL = 5000;
    const VEHICLE_IMAGES = [
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__5_-removebg-preview.png",
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__6_-removebg-preview.png",
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__7_-removebg-preview.png",
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/driver.png"
    ];

    function initMap() {
      const params = new URLSearchParams(window.location.search);
      const userLat = parseFloat(params.get("userLat")) || 41.1533;
      const userLng = parseFloat(params.get("userLng")) || 20.1683;

      map = L.map('map').setView([userLat, userLng], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      L.circleMarker([userLat, userLng], {
        color: "blue",
        radius: 8,
        fillColor: "white",
        fillOpacity: 1
      }).addTo(map);

      for (let i = 0; i < DRIVERS_COUNT; i++) {
        const start = randomPoint(userLat, userLng, 0.05);
        const end = randomPoint(userLat, userLng, 0.05);
        createDriverRoute(start, end, i % VEHICLE_IMAGES.length);
      }

      setInterval(() => {
        driverRoutes.forEach(animateDriverMovement);
      }, UPDATE_INTERVAL);
    }

    function randomPoint(lat, lng, range) {
      return [lat + (Math.random() * 2 - 1) * range, lng + (Math.random() * 2 - 1) * range];
    }

    function createDriverRoute(start, end, vehicleImageIndex) {
      const marker = L.marker(start, {
        icon: L.icon({
          iconUrl: VEHICLE_IMAGES[vehicleImageIndex],
          iconSize: [40, 40],
          iconAnchor: [20, 20]
        })
      }).addTo(map);

      driverMarkers.push(marker);
      driverRoutes.push({ marker, route: [start, end], routeIndex: 0 });
    }

    function animateDriverMovement(driver) {
      const { marker, route, routeIndex } = driver;
      if (route.length < 2) return;

      const start = route[routeIndex];
      const end = route[(routeIndex + 1) % route.length];
      const steps = 50;
      let step = 0;

      const interval = setInterval(() => {
        step++;
        const lat = start[0] + ((end[0] - start[0]) * step / steps);
        const lng = start[1] + ((end[1] - start[1]) * step / steps);

        marker.setLatLng([lat, lng]);

        if (step >= steps) {
          clearInterval(interval);
          driver.routeIndex = (routeIndex + 1) % route.length;
        }
      }, UPDATE_INTERVAL / steps);
    }
  </script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body onload="initMap()">
  <div id="map"></div>
</body>
</html>
