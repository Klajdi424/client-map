<!DOCTYPE html>
<html>
<head>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDESOPDnAmfX5e5qqWc0Smy6kpj3kfN_J0" async defer></script>
  <script>
    let map;
    let directionsService;
    const driverRoutes = [];
    const DRIVERS_COUNT = 10;
    const UPDATE_INTERVAL = 3000; 

    function initMap() {
      const params = new URLSearchParams(window.location.search);
      const userLoc = {
        lat: parseFloat(params.get("userLat")) || 51.5074,
        lng: parseFloat(params.get("userLng")) || -0.1278
      };

      map = new google.maps.Map(document.getElementById("map"), {
        center: userLoc,
        zoom: 13,
        disableDefaultUI: true
      });

      new google.maps.Marker({
        position: userLoc,
        map: map,
        icon: {
          url: "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/images%20(9).jpg",
          scaledSize: new google.maps.Size(50, 50)
        }
      });

      directionsService = new google.maps.DirectionsService();

      for (let i = 0; i < DRIVERS_COUNT; i++) {
        const start = randomPoint(userLoc, 0.01);
        const end = randomPoint(userLoc, 0.01);
        createDriverRoute(start, end);
      }

      const bounds = new google.maps.LatLngBounds();
      bounds.extend(userLoc);
      driverRoutes.forEach(driver => {
        if (driver.routePoints && driver.routePoints.length)
          bounds.extend(driver.routePoints[0]);
      });
      map.fitBounds(bounds);

      setInterval(() => {
        driverRoutes.forEach(animateDriverMovement);
      }, UPDATE_INTERVAL);
    }

    function randomPoint(center, range) {
      return {
        lat: center.lat + (Math.random() * 2 - 1) * range,
        lng: center.lng + (Math.random() * 2 - 1) * range
      };
    }

    function createDriverRoute(start, end) {
      directionsService.route({
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          const routePoints = result.routes[0].overview_path;
          const marker = new google.maps.Marker({
            position: routePoints[0],
            map: map,
            icon: {
              url: "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/driver.png",
              scaledSize: new google.maps.Size(50, 50)
            }
          });
          driverRoutes.push({ marker, routePoints, routeIndex: 0 });
        }
      });
    }

    function animateDriverMovement(driver) {
      if (driver.routePoints && driver.routePoints.length) {
        const nextIndex = (driver.routeIndex + 1) % driver.routePoints.length;
        const nextPoint = driver.routePoints[nextIndex];
        smoothMarkerTransition(driver.marker, driver.routePoints[driver.routeIndex], nextPoint);
        driver.routeIndex = nextIndex;
      }
    }

    function smoothMarkerTransition(marker, start, end) {
      const steps = 30; 
      const stepTime = UPDATE_INTERVAL / steps;
      let stepCount = 0;

      const latDelta = (end.lat() - start.lat()) / steps;
      const lngDelta = (end.lng() - start.lng()) / steps;

      const interval = setInterval(() => {
        stepCount++;
        const newLat = start.lat() + latDelta * stepCount;
        const newLng = start.lng() + lngDelta * stepCount;

        marker.setPosition({ lat: newLat, lng: newLng });

        if (stepCount >= steps) {
          clearInterval(interval);
        }
      }, stepTime);
    }
  </script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body onload="initMap()">
  <div id="map"></div>
</body>
</html>
