<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    const driverMarkers = [];
    const DRIVERS_COUNT = 20;
    const UPDATE_INTERVAL = 5000;
    const VEHICLE_IMAGES = [
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__5_-removebg-preview.png",
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__6_-removebg-preview.png",
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/OIP__7_-removebg-preview.png",
      "https://raw.githubusercontent.com/Klajdi424/image/refs/heads/main/driver.png"
    ];

    function initMap() {
      const params = new URLSearchParams(window.location.search);
      const userLat = parseFloat(params.get("userLat")) || 41.3275;
      const userLng = parseFloat(params.get("userLng")) || 19.8189;

      map = L.map('map').setView([userLat, userLng], 14);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      
      L.circleMarker([userLat, userLng], {
        radius: 10,
        fillColor: "#ff0000",
        color: "#000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map);

      for (let i = 0; i < DRIVERS_COUNT; i++) {
        const start = randomPoint(userLat, userLng, 0.02);
        createDriver(start, i % VEHICLE_IMAGES.length);
      }

      setInterval(updateDriverPositions, UPDATE_INTERVAL);
    }

    function randomPoint(lat, lng, range) {
      return [lat + (Math.random() * 2 - 1) * range, lng + (Math.random() * 2 - 1) * range];
    }

    function createDriver(start, vehicleImageIndex) {
      const marker = L.marker(start, {
        icon: L.icon({
          iconUrl: VEHICLE_IMAGES[vehicleImageIndex],
          iconSize: [50, 50],
          iconAnchor: [25, 25]
        })
      }).addTo(map);
      
      driverMarkers.push({ marker, route: [], routeIndex: 0 });
      fetchRoute(start, marker);
    }

    async function fetchRoute(start, marker) {
      const end = randomPoint(start[0], start[1], 0.02);
      const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.routes.length > 0) {
        const routePoints = data.routes[0].geometry.coordinates.map(([lng, lat]) => [lat, lng]);
        driverMarkers.find(d => d.marker === marker).route = routePoints;
      }
    }

    function updateDriverPositions() {
      driverMarkers.forEach(driver => {
        if (driver.route.length > 0) {
          driver.routeIndex = (driver.routeIndex + 1) % driver.route.length;
          driver.marker.setLatLng(driver.route[driver.routeIndex]);
        }
      });
    }
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body onload="initMap()">
  <div id="map"></div>
</body>
</html>
